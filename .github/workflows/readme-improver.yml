name: "AI README Improver"

on:
  workflow_dispatch:  # âœ… Manual run support
    inputs:
      email:
        description: "Custom email for the README"
        required: false
      logo-path:
        description: "Path to custom logo"
        required: false

  pull_request:
    paths: ["README.md"]

  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-readme:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - run: pip install -r requirements.txt

      - name: Set archive timestamp
        run: echo "TIMESTAMP=$(date -u +'%Y-%m-%d-%H-%M')" >> $GITHUB_ENV

      - name: Run AI README Improver
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python run_improver.py \
            --config readme-improver.config.yaml \
            --email "${{ github.event.inputs.email || secrets.README_EMAIL }}" \
            --logo-path "${{ github.event.inputs.logo-path || 'assets/logo.png' }}"

      - name: Archive README and apply improvements
        run: |
          mkdir -p oldreadme/$TIMESTAMP
          if [ -f README.md ]; then
            cp README.md "oldreadme/$TIMESTAMP/README.md"
          fi
          cp suggestions.md "oldreadme/$TIMESTAMP/suggestions.md"
          cp README.improved.md README.md

      - name: Commit and push updated README
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md README.improved.md suggestions.md oldreadme/ || true
          git diff --cached --quiet || git commit -m "Auto update README"
          git push origin HEAD:${{ github.head_ref || github.ref_name }}

      - name: Comment on PR with suggestions
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python post_comment.py

      - name: Clean up suggestion file
        if: github.event_name == 'pull_request'
        run: rm -f suggestions.md
